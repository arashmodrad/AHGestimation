<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Compute FHG fits from river measurements.">
<title>Compute Feature-based Hydrualic Geometries • FHGestimation</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Compute Feature-based Hydrualic Geometries">
<meta property="og:description" content="Compute FHG fits from river measurements.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">FHGestimation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="fhgestimation">FHGestimation<a class="anchor" aria-label="anchor" href="#fhgestimation"></a>
</h1></div>
<p>Using pre-processed observation data from the USGS, we can evaluate learn some things about estimating power law fits from noisy data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">FHGestimation</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"extra/usgs_obs_hydraulics.rda"</span><span class="op">)</span></span></code></pre></div>
<p>Taking a random station we subset data occurring after 2010-01-01 and that falls within the 2 year reoccurance interval (defined via NWM v21 reanalysis product).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">=</span> <span class="fl">50</span></span>
<span>  </span>
<span><span class="va">tmp</span> <span class="op">=</span> <span class="va">usgs_obs</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">'2010-01-01'</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">inChannel</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Ymean</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">V</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">TW</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Q</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.finite</a></span><span class="op">(</span><span class="va">Ymean</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">date</span>,<span class="va">Q</span>, <span class="va">TW</span>, <span class="va">V</span>, Y <span class="op">=</span> <span class="va">Ymean</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 80  5</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-4-1.png" width="100%"></p>
<div class="section level2">
<h2 id="single-relationship-fits">Single Relationship fits<a class="anchor" aria-label="anchor" href="#single-relationship-fits"></a>
</h2>
<p>Here we use the <code>FHGestimation</code> package to fit the Q-Y relationship using OLS and NLS models:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/fhg_estimate.html">fhg_estimate</a></span><span class="op">(</span>Q <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">Q</span>, Y <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">Y</span>, allowance <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span></span>
<span><span class="co">#&gt; NLS performs best for the Q-Y realtionship</span></span>
<span><span class="co">#&gt;   type       exp      coef     nrmse   pb  mean_ape      min_ape  max_ape</span></span>
<span><span class="co">#&gt; 1    Y 0.4781663 0.2122345 0.1324314 -0.8 0.1410238 0.0084845016 2.227273</span></span>
<span><span class="co">#&gt; 2    Y 0.4102660 0.2540058 0.1542132 -2.3 0.1326987 0.0006162981 2.296017</span></span>
<span><span class="co">#&gt;   method</span></span>
<span><span class="co">#&gt; 1    nls</span></span>
<span><span class="co">#&gt; 2    ols</span></span></code></pre></div>
<p>Overall the the NLS model provides a better fit (albeit small) when measured both by nRMSE and pBais.</p>
</div>
<div class="section level2">
<h2 id="full-hydraulic-fits">Full Hydraulic fits<a class="anchor" aria-label="anchor" href="#full-hydraulic-fits"></a>
</h2>
<p>When we have data regarding all three hydraulic states (V,TW,Y) we can ensure that the solutions found are physically valid (meets the continuity constraint Q = Y x V x TW).</p>
<p>In this mode the OLS and NLS models are fit, and if continuity is not met, then a Evolutionary approach is implemented. Doing so produces three unique fits for three variables (27 total combinations). These are crossed to identify the best performing relationships that meet continuity at a prescribed allowance:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="reference/fhg_estimate.html">fhg_estimate</a></span><span class="op">(</span>Q <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">Q</span>, </span>
<span>             V <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">V</span>, </span>
<span>             TW <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">TW</span>, </span>
<span>             Y <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">Y</span>, </span>
<span>             allowance <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span><span class="op">$</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="co">#&gt; NLS performs best for the Q-Y realtionship</span></span>
<span><span class="co">#&gt; NLS performs best for the Q-TW realtionship</span></span>
<span><span class="co">#&gt; NLS performs best for the Q-V realtionship</span></span>
<span><span class="co">#&gt; NLS meets continuity ...  👍</span></span>
<span><span class="co">#&gt; OLS meets continuity ...  👍</span></span>
<span><span class="co">#&gt; The best performing method (nls) is physically valid ... 😂</span></span>
<span><span class="co">#&gt;     Y  TW   V viable   Y_error  TW_error   V_error tot_error condition</span></span>
<span><span class="co">#&gt; 1 nls nls nls   TRUE 0.1324314 0.1228453 0.1710605 0.4263372       nls</span></span>
<span><span class="co">#&gt; 2 ols nls ols   TRUE 0.1542132 0.1228453 0.1954694 0.4725279     combo</span></span>
<span><span class="co">#&gt; 3 ols ols ols   TRUE 0.1542132 0.1238710 0.1954694 0.4735535       ols</span></span>
<span><span class="co">#&gt;           c         f        a         b         k         m        r</span></span>
<span><span class="co">#&gt; 1 0.2122345 0.4781663 18.37954 0.1746765 0.2682225 0.3370959 2.737440</span></span>
<span><span class="co">#&gt; 2 0.2540058 0.4102660 18.37954 0.1746765 0.2074655 0.4250980 2.348719</span></span>
<span><span class="co">#&gt; 3 0.2540058 0.4102660 18.73285 0.1638955 0.2074655 0.4250980 2.503217</span></span></code></pre></div>
<p>In the above example we see that NLS was able to provide better fits the OLS but neither NLS or OLS was able to provide physically valid solutions (c1, c2, viable). While the GA approach was able to provide a physically valid solution, its error was almost 10% higher then the OLS/NLS methods.</p>
<p>However a combined approach of a NLS, OLS, and GA fit was able to provide a physically valid result with only 0.9% more error the seen in the best performing NLS method.</p>
<p><img src="reference/figures/README-unnamed-chunk-7-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="take-home-points-of-this-work">Take home points of this work:<a class="anchor" aria-label="anchor" href="#take-home-points-of-this-work"></a>
</h2>
<blockquote>
<p>NLS is better then OLS for predicting single relationships in almost every case and should become the defacto approach.</p>
</blockquote>
<blockquote>
<p>When fitting an entire system, OLS and NLS often provide results that are not physically valid.</p>
</blockquote>
<blockquote>
<p>EA approaches can always find a physically valid solution but often introduce disproportionate error.</p>
</blockquote>
<blockquote>
<p>Instead, using a mishmash of NLS, OLS, and GA fits (in cases of non-valid solutions), can find solutions with minimal error AND physical validity. We argue this approach is the proper way to fit FHG relationships.</p>
</blockquote>
<blockquote>
<p>This process in formalized in the FHGestimation R packages.</p>
</blockquote>
</div>
</div>
  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>CC0</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing FHGestimation</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Mike Johnson <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-5288-8350" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>
<a href="https://www.nsf.gov" class="external-link"><img src="reference/figures/nsf-logo.png" height="36" alt="NSF"></a> <br><small class="roles"> Funder </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mike Johnson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
