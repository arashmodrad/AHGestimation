---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

library(AHGestimation)
library(dplyr)
library(ggplot2)
library(patchwork)
```

# AHGestimation

Using pre-processed observation data from the USGS, we can evaluate learn some things about estimating power law fits from noisy data. 

```{r}
length(usgs_obs)
```

Taking a random station we subset data occurring after 2010-01-01 and that falls within the 2 year reoccurance interval (defined via NWM v20 reanalysis product).

```{r}
index = 5
  
tmp = usgs_obs[[index]] %>% 
    filter(as.Date(date) > as.Date('2010-01-01')) %>% 
    filter(inChannel == TRUE) %>%
    filter(Ymean > 0) %>%
    filter(V > 0) %>%
    filter(TW > 0) %>%
    filter(Q > 0) %>%
    filter(is.finite(Ymean)) %>% dplyr::select(date,Q, TW, V, Y = Ymean)

dim(tmp)

```

```{r, echo = F}

g1 = ggplot(data = tmp ) + 
  geom_point(aes(x = Q, y = Y)) + 
  theme_light()  + 
  labs(title = 'Q-Y Relationship')

g2 = ggplot(data = tmp ) + 
  geom_point(aes(x = Q, y = TW)) + 
  theme_light() + 
  labs(title = 'Q-TW Relationship')

g3 = ggplot(data = tmp ) + 
  geom_point(aes(x = Q, y = V)) + 
  theme_light()  + 
  labs(title = 'Q-V Relationship')

g1 + g2 + g3
```

## Single Relationship fits

Here we use the ahg estimate package to fit the Q-Y relationship using OLS and NLS models:

```{r}
ahg_estimate(Q = tmp$Q, Y = tmp$Y, allowance = .05)
```

Overall we see that the the NLS model provides a better fit (albeit small) when measured both by nRMSE and pBais.


## Full Hydraulic fits

When we have data regarding all three hydraulic states (V,TW,Y) we can ensure that the solutions found are physically valid (meets the continuity constraint Q = Y*V*TW).

In this mode the OLS and NLS models are fit, and if continuity is not met, then a Evolutionary approach is implemented. Doing so produces 3 unique fits for 3 variables (27 total combinations). These are crossed to identify the best performing relationships that meet continuity at a prescribed allowance:

```{r}
ahg_estimate(Q = tmp$Q, V = tmp$V, TW = tmp$TW, Y = tmp$Y, allowance = .05)
```

In the above example we see that NLS was able to provide better fits the OLS but neither  NLS or OLS was able to provide physically valid solutions (c1, c2, viable). While the GA approach was able to provide a physically valid solution, its error was almost 10% higher then the OLS/NLS methods.

However a combined approach of a NLS, OLS, and GA fit was able to provide a physically valid result with only .9% more error the seen in the best performing NLS method.

## Take home points of this paper:

> NLS is better then OLS for predicting single relationships in almost every case and should become the defacto approach.

> When fitting an entire system, OLS and NLS often provide results that are not physically valid.

> GA approaches can always find a physically valid solution but often introduce disproportionate error. 

> Instead, using a mishmash of NLS, OLS, and GA fits (in cases of non-valid solutions), can find solutions with minimal error AND physical validity. We argue  this approach  is the proper way to fit AHG relationships.

> This process in formalized in the AHGestimation R packages.
